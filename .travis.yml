language: cpp
os:
- linux
- osx
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - g++-4.8-multilib
    - gcc-multilib
    - build-essential
    - libbluetooth-dev
    - libudev-dev
    - libusb-1.0-0-dev
env:
  matrix:
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="amd64" MAIN_BUILD="true"
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
matrix:
  exclude:
  - os: osx
    env: PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
branches:
  only:
  - "/^v[0-9]/"
before_install:
- PACKAGER_URL="https://meshblu-connector.octoblu.com/tools/packager/latest"
- curl -fsS "${PACKAGER_URL}/travis_install_node.sh" -o /tmp/travis_install_node.sh
- chmod +x /tmp/travis_install_node.sh
- ". /tmp/travis_install_node.sh"
- if [ "$TRAVIS_OS_NAME" == "linux" -a "$MAIN_BUILD" == "true" ]; then export NPM_PUBLISH="true"; fi
install:
- npm install --build-from-source
script:
- npm test
before_deploy:
- npm install --build-from-source --production
- npm install meshblu-connector-packager
- npm dedupe
- npm install -g flatten-packages
- flatten-packages
- npm run package
deploy:
- provider: releases
  api_key:
    secure: "B7w1ct/iAuWUsHh4KI+HhgvBxi61F188kOH1qSkF8BmUov5Mdas69nngbr1BmLJg+x8P0Ha6BSVJ4vS/tL567bFOsmjkqeeXpvHP5TNpLX8fb9kib9lKma6koPWxMp2jWe5agHcVEKK8z0TMXlyjy6NSTDh/QLbXRjSoplyQwzVH83gtLiD7tErtscJQmgALHWeTb8/v/1FFCnLE2h/iOUazCYhRLBBzRQY8nvjmCi/PowZpMjxv+CgTNwlVXtRgTXjy/mkmZ+Y/W9K7ovWw7gpeMQYlvGUK43I2ZTy4FYLb20MEbCqlF1g2pvQVpAtPZHMv8RG6MLKxXNA9B+1ig/P7xYsolWtAa4H/rK9WSmBht0EqDjp88BcbKVLuMa6NJ6P6ki2YhEm1YF4i3Pc7uxDu1NdEYRGCsnVDpMNxWnC1yzBKPrpueRhfAthjhE4o627JSeMpf7a7U8CDilcn1ygcxloB0uG6qrrZOeKUrlJbYHyMfsTM3xHuFuQVVHndLXOdPPoXEg6B4wtf3pqjgZt0HzELKfB/YD6oon3edPxMYqYzDy0Hvl8SjLJqxX6WdifK/a2Mtr9tSzmAb5vc0hpLmyOqcJsY4Vhg3WhxW0CAxbfim6oBJ3weRB6EWa6hVXLBSFD8P0jHknySvcpSoWFgyrnwI+jY7YcRivCb+wQ="
  file_glob: true
  file:
  - "deploy/*"
  skip_cleanup: true
  on:
    tags: true
- provider: npm
  email: serveradmin@octoblu.com
  api_key:
    secure: "Usz4td40/ExcUa/aJAPDu+BKUq37hJvt2UkHu01rthRpNRvegrztX/RzBnFolQyoU1GbxLVA1b2Zt69UE4m16wZe+v9RVhkaCyrLEyvCYZZpVitFldKt2GN5UzNQnv82M8xHMRR1FNRURmcD9BSwwBNoQFHAUxDcSgAr5ai3GfaE2IoU7hzdnI+V1WbL1gLUYMpJ+i3SxP/p/VO0I0ER57jxLvzaSbpWJJ/qr8jowspgikoOBlLMK6BGJf8geBHgMsXhMeywh8ZwxcQRB6oW9oAo7eAZGcLUwAPWNYb7dpXQPNi9rzshvABZ3kourMJz53dWrt+1XGGNplAmtg6ByStDCWmwYwogXge0DUyRwjb5J0U3hKRpz9KpZnQq+gCv3zlpwg3KM5CIw27191ZFvlY5pXp+c/Qp5USV1UBP+OzlTN6McpsHS58u1OAd5YgRXRN5VOZ8rAMa4av+I6Pb5H/KaROm+xAM73n5MnJKUUCk4Jr0CQqzNoSObgGtcJjUqUGmr6a4+W1XXt31K2Ef/+srbxl3p4SLtHIX/uMnyrTRQT3Gt17BE/8OuWreASySVCXW/uOnZ2Ke0rMvJ9OkBXomy+yVNb40d6soVacKi1BCcKa+MK3mEvrPhwEoZGf3FhIwB3E90RlE/RpQIZ4/WmgZwOb3D8T6aNXWrZ77f8I="
  on:
    tags: true
    condition: "$NPM_PUBLISH = true"
